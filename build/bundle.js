(()=>{"use strict";class e{constructor(e,t){this._formElement=e.formElement,this._inputElement=e.inputElement,this._buttonElement=e.buttonElement,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorShowClass=e.errorShowClass,this._targetFormElement=t,this._inputList=Array.from(t.querySelectorAll(this._inputElement)),this._button=t.querySelector(this._buttonElement)}_showInputError(e,t){const s=this._targetFormElement.querySelector(`#${e.id}-error`);e.classList.add(this._inputErrorClass),s.textContent=t,s.classList.add(this._errorShowClass)}_hideInputError(e){const t=this._targetFormElement.querySelector(`#${e.id}-error`);e.classList.remove(this._inputErrorClass),t.classList.remove(this._errorShowClass),t.textContent=""}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput(this._inputList)?(this._button.classList.add(this._inactiveButtonClass),this._button.setAttribute("disabled",!0)):(this._button.classList.remove(this._inactiveButtonClass),this._button.removeAttribute("disabled"))}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}resetErrors(){this._inputList.forEach((e=>{this._hideInputError(e)})),this._toggleButtonState()}enableValidation(){this.resetErrors(this._targetFormElement),this._setEventListeners(this._targetFormElement)}}class t{constructor(e,t,{handleLikeClick:s,handleCardDelete:r},n,i){this._name=e.name,this._link=e.link,this._likes=e.likes,this._cardId=e._id,this._currentId=n,this._ownerId=e.owner._id,this._handleCardClick=t,this._handleLikeClick=s,this._handleCardDelete=r,this._cardSelector=i}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".element").cloneNode(!0)}_getView(){this._ownerId!==this._currentId&&this._element.querySelector(".element__trash").classList.add("element__trash_block")}generateCard(){return this._element=this._getTemplate(),this._setEventListeners(),this._element.querySelector(".element__title").textContent=this._name,this._element.querySelector(".element__photo").src=this._link,this._element.querySelector(".element__photo").alt=this._name,this._element.querySelector(".element__heart-number").textContent=this._likes.length,this._getView(),this._element}isLiked(){return this._isLiked}setLike(e){this._isLiked=e.likes.filter((e=>e._id==this._currentId)).length>0,this._element.querySelector(".element__heart-number").textContent=e.likes.length,this._isLiked?this._element.querySelector(".element__heart").classList.add("element__heart_active"):this._element.querySelector(".element__heart").classList.remove("element__heart_active")}removeCard(){this._element.remove(),this._element=null}_setEventListeners(){this._element.querySelector(".element__heart").addEventListener("click",(()=>this._handleLikeClick())),this._element.querySelector(".element__trash").addEventListener("click",(()=>this._handleCardDelete())),this._element.querySelector(".element__photo").addEventListener("click",(()=>this._handleCardClick(this._name,this._link)))}}const s={formElement:".popup__form",inputElement:".popup__field",buttonElement:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__field_type_error",errorShowClass:"error_type_visible"},r="popup_opened",n=document.querySelector(".popup__form_type_profile"),i=document.querySelector(".popup__form_type_add"),o=document.querySelector(".popup_type_card-avatar"),a=n.querySelector(".popup__field_type_name"),l=n.querySelector(".popup__field_type_about"),h=document.querySelector(".profile__button-pen"),_=document.querySelector(".profile__button-plus"),c=document.querySelector(".profile__button-avatar"),u=document.querySelectorAll(".popup__button_type_save");class d{constructor(e){this._popup=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this)}open(){this._popup.classList.add(r),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove(r),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}setEventListeners(){this._popup.addEventListener("mousedown",(e=>{(e.target.classList.contains("popup_opened")||e.target.classList.contains("popup__close-btn"))&&this.close()}))}}class p extends d{constructor(e,t){super(e),this._form=this._popup.querySelector(".popup__form"),this._handleFormSubmit=t,this._input=Array.from(this._form.querySelectorAll(".popup__field"))}close(){super.close(),this._form.reset()}_getInputValues(){const e={};return this._input.forEach((t=>{e[t.name]=t.value})),e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())}))}}let m=null;const E=new e(s,i),f=new e(s,n),v=new e(s,o);f.enableValidation(),E.enableValidation(),v.enableValidation();const y=new class{constructor(e,t,s){this._nameElement=document.querySelector(e),this._aboutElement=document.querySelector(t),this._avatarElement=document.querySelector(s)}getUserInfo(){return{name:this._nameElement.textContent,about:this._aboutElement.textContent}}setUserInfo(e){this._nameElement.textContent=e.name,this._aboutElement.textContent=e.about,this._avatarElement.style.backgroundImage=`url(${e.avatar})`}setAvatarInfo(e){this._avatarElement.style.backgroundImage=`url(${e})`}}(".profile__name",".profile__about",".profile__avatar-picture"),b=new class extends d{constructor(e){super(e),this._image=this._popup.querySelector(".popup__picture"),this._text=this._popup.querySelector(".popup__title-picture")}open(e,t){this._image.src=t,this._image.alt=e,this._text.textContent=e,super.open()}}(".popup_type_picture"),C=new class extends d{constructor(e){super(e),this._form=this._popup.querySelector(".popup__form")}setFormSubmitHandler(e){this._setFormSubmitHandler=e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._setFormSubmitHandler()}))}}(".popup_type_card-delete"),L=new p(".popup_type_card-add",(e=>{k(!0),U.createCard(e).then((e=>{q(e,m,w),L.close()})).catch((e=>{console.log(`${e}`)})).finally((()=>{k(!1)}))})),g=new p(".popup_type_profile",(e=>{k(!0),U.setUserInfo(e).then((e=>{y.setUserInfo(e),g.close()})).catch((e=>{console.log(`${e}`)})).finally((()=>{k(!1)}))})),S=new p(".popup_type_card-avatar",(e=>{k(!0),U.setAvatar(e).then((e=>{y.setAvatarInfo(e.avatar),S.close()})).catch((e=>{console.log(`${e}`)})).finally((()=>{k(!1)}))}));function k(e){e?Array.from(u).forEach((e=>{e.value="Сохранение..."})):Array.from(u).forEach((e=>{e.value="Сохранить"}))}function I(e,t){b.open(e,t)}function q(e,s,r){const n=new t(e,I,{handleLikeClick:()=>function(e,t){(e.isLiked()?U.dislikeCard(t._id):U.likeCard(t._id)).then((t=>{e.setLike(t)})).catch((e=>{console.log(`${e}`)}))}(n,e),handleCardDelete:()=>function(e){C.setFormSubmitHandler((()=>{U.deleteCard(e._cardId).then((()=>{e.removeCard(),C.close()})).catch((e=>{console.log(`${e}`)}))})),C.open()}(n)},s,"#element-template"),i=n.generateCard();n.setLike(e),r.setItem(i)}const w=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.reverse().forEach((e=>this._renderer(e)))}setItem(e){this._container.prepend(e)}}({renderer:e=>{q(e,m,w)}},".elements");g.setEventListeners(),S.setEventListeners(),L.setEventListeners(),b.setEventListeners(),C.setEventListeners(),h.addEventListener("click",(function(){const e=y.getUserInfo();a.value=e.name,l.value=e.about,f.resetErrors(n),g.open()})),c.addEventListener("click",(function(){const e=y.getUserInfo();v.resetErrors(o),S.open(e)})),_.addEventListener("click",(function(){E.resetErrors(i),L.open()}));const U=new class{constructor({baseUrl:e,headers:t}){this.baseUrl=e,this.headers=t}getUserInfo(){return fetch(`${this.baseUrl}users/me`,{headers:this.headers}).then(this._getResponseData)}getInitialCards(){return fetch(`${this.baseUrl}cards`,{headers:this.headers}).then(this._getResponseData)}setUserInfo(e){return fetch(`${this.baseUrl}users/me`,{method:"PATCH",headers:this.headers,body:JSON.stringify({name:e.name,about:e.about})}).then(this._getResponseData)}createCard(e){return fetch(`${this.baseUrl}cards`,{method:"POST",headers:this.headers,body:JSON.stringify({name:e.name,link:e.link})}).then(this._getResponseData)}likeCard(e){return fetch(`${this.baseUrl}cards/likes/${e}`,{method:"PUT",headers:this.headers}).then(this._getResponseData)}deleteCard(e){return fetch(`${this.baseUrl}cards/${e}`,{method:"DELETE",headers:this.headers}).then(this._getResponseData)}dislikeCard(e){return fetch(`${this.baseUrl}cards/likes/${e}`,{method:"DELETE",headers:this.headers}).then(this._getResponseData)}setAvatar(e){return fetch(`${this.baseUrl}users/me/avatar`,{method:"PATCH",headers:this.headers,body:JSON.stringify(e)}).then(this._getResponseData)}_getResponseData(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-38/",headers:{authorization:"84de48d5-ee06-4635-a9d3-6fdec2b04ec2","Content-Type":"application/json"}});Promise.all([U.getInitialCards(),U.getUserInfo()]).then((([e,t])=>{y.setUserInfo(t),m=t._id,w.renderItems(e)})).catch((e=>{console.log(`${e}`)}))})();